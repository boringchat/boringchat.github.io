<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Boring Chat</title>
<style>
  body{
    background:#000;
    color:#eee;
    font-family:Poppins,Arial,sans-serif;
    margin:0;
    display:flex;
    justify-content:center;
    align-items:center;
    min-height:100vh;
  }
  #app{background:#111;padding:20px;border-radius:14px;width:90%;max-width:500px;}
  input,button{width:100%;padding:10px;margin:6px 0;border:none;border-radius:8px;font-size:1em;}
  input{background:#222;color:#eee;}
  button{background:#444;color:#eee;cursor:pointer;}
  button:hover{background:#666;}
  #messages{background:#181818;height:300px;overflow-y:auto;border-radius:10px;padding:10px;margin-bottom:10px;}
  .message{margin:4px 0;padding:5px 8px;border-radius:6px;background:#222;}
  .own{background:#555;text-align:right;}
  img.chat-img{max-width:100%;border-radius:8px;margin-top:4px;}
</style>
</head>
<body>
<div id="app">
  <h1>ðŸ’¬ Boring Chat</h1>
  <div id="login">
    <input id="displayName" placeholder="Display name">
    <input id="roomName" placeholder="Room name">
    <button id="joinRoom">Join / Create</button>
    <button id="adminLogin">Moderator Login</button>
  </div>

  <div id="chat" style="display:none">
    <h2 id="roomHeader"></h2>
    <div id="messages"></div>
    <input id="messageInput" placeholder="Type a messageâ€¦">
    <input type="file" id="imgUpload" accept="image/*">
    <button id="gifBtn">Search GIFs</button>
    <button id="sendBtn">Send</button>
    <button id="leaveBtn">Leave Room</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, doc, getDoc, setDoc, updateDoc, arrayUnion, onSnapshot, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyAr-HmbO9FHKQP-krDB95hvYf_5J_ODXeo",
  authDomain: "boringchat-e9299.firebaseapp.com",
  databaseURL: "https://boringchat-e9299-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "boringchat-e9299",
  storageBucket: "boringchat-e9299.firebasestorage.app",
  messagingSenderId: "944753645447",
  appId: "1:944753645447:web:1206e5fc2f7ef8428c6522",
  measurementId: "G-00RB4RNZEG"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

let currentRoom=null, displayName="", isAdmin=false;

const nameInput=document.getElementById("displayName");
const roomInput=document.getElementById("roomName");
const msgInput=document.getElementById("messageInput");
const joinBtn=document.getElementById("joinRoom");
const sendBtn=document.getElementById("sendBtn");
const messagesDiv=document.getElementById("messages");
const chatDiv=document.getElementById("chat");
const loginDiv=document.getElementById("login");
const header=document.getElementById("roomHeader");
const upload=document.getElementById("imgUpload");

joinBtn.onclick=async()=>{
  const room=roomInput.value.trim();
  displayName=nameInput.value.trim();
  if(!room||!displayName)return alert("Enter name & room!");
  const refRoom=doc(db,"rooms",room);
  const snap=await getDoc(refRoom);
  if(!snap.exists())await setDoc(refRoom,{messages:[]});
  currentRoom=refRoom;
  loginDiv.style.display="none"; chatDiv.style.display="block";
  header.textContent="Room: "+room;
  onSnapshot(refRoom,(d)=>{
    const data=d.data();
    messagesDiv.innerHTML="";
    data.messages.forEach(m=>{
      const div=document.createElement("div");
      div.className="message"+(m.sender===displayName?" own":"");
      if(m.type==="image"){
        const img=document.createElement("img");
        img.src=m.text; img.className="chat-img";
        div.appendChild(img);
      }else{
        div.textContent=`${m.sender}: ${m.text}`;
      }
      messagesDiv.appendChild(div);
    });
    messagesDiv.scrollTop=messagesDiv.scrollHeight;
  });
};

msgInput.addEventListener("keypress",(e)=>{
  if(e.key==="Enter") sendBtn.click();
});

sendBtn.onclick=async()=>{
  const text=msgInput.value.trim();
  if(!text)return;
  await updateDoc(currentRoom,{messages:arrayUnion({sender:displayName,text,type:"text",time:Date.now()})});
  msgInput.value="";
};

// image upload
upload.onchange=async(e)=>{
  const f=e.target.files[0]; if(!f)return;
  const imgRef=ref(storage,`uploads/${Date.now()}_${f.name}`);
  await uploadBytes(imgRef,f);
  const url=await getDownloadURL(imgRef);
  await updateDoc(currentRoom,{messages:arrayUnion({sender:displayName,text:url,type:"image",time:Date.now()})});
};

// moderator login
document.getElementById("adminLogin").onclick=()=>{
  const p=prompt("Enter moderator password:");
  if(p==="admin24"){isAdmin=true;alert("Moderator mode enabled");deleteRoomOption();}
  else alert("Wrong password");
};

function deleteRoomOption(){
  const del=document.createElement("button");
  del.textContent="Delete this room";
  del.onclick=async()=>{
    if(confirm("Delete this room?")){
      await deleteDoc(currentRoom);
      alert("Room deleted");
      location.reload();
    }
  };
  chatDiv.appendChild(del);
}
</script>
</body>
</html>
